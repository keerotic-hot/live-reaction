<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Live - Reaction</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    <style>
        a.page {
            width: 100%;
            height: 100%;
            display: block;
            /* overflow: hidden; */
            height: 80px;
            padding: 10px 0;
            margin: 10px 0;
        }
        
        .icon {
            width: 50px;
            height: 50px;
            display: block;
            margin: 0 auto;
            background-size: cover !important;
            box-shadow: #999 3px 3px 6px;
            border-radius: 10px;
        }
        
        .name {
            display: block;
            margin: 0 auto;
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: 12pt;
            text-align: center;
            margin-top: 10px;
            line-height: 14pt;
        }
        
        .header {
            height: 50px;
            line-height: 50px;
            text-align: center;
            font-size: 16pt;
        }
        
        #page-accounts,
        #page-videos,
        #page-live {
            display: none;
        }
        
        .accounts #page-accounts,
        .videos #page-videos,
        .live #page-live {
            display: block
        }
        
        .btn1 {
            width: 50px;
            height: 50px;
            display: block;
            border-right: solid 1px #ccc;
            position: absolute;
            left: 0;
            top: 0;
            line-height: 50px;
            padding: 2px;
            color: #fff !important;
        }
        
        #title-page {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 60px;
        }
        
        #list-live-videos {
            margin-top: 15px;
        }
        
        #list-live-videos li {
            margin-top: 15px;
            opacity: 0.3;
            pointer-events: none;
        }
        
        #list-live-videos li.VOD {
            opacity: 0.3;
            pointer-events: none;
        }
        
        #list-live-videos li.LIVE {
            opacity: 1;
            pointer-events: all;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
</head>

<body>
    <fb:login-button id="bt-login" scope="public_profile,email,pages_show_list" onlogin="checkLoginState();"></fb:login-button>
    <div class="container" id="page-accounts">
        <div class="row header bg-primary">
            <div class="col-md-8 center-block">เลือก page</div>
        </div>
        <div class="row" id="accounts-list" style="margin:0"></div>
    </div>
    <div class="container" id="page-videos">
        <div class="row header bg-primary">
            <div class="col-md-12 col-sm-12 col-xs-12 center-block" id="title-page">เลือก live</div>
            <div class="pull-left">
                <a href="javascript:" onclick="choosePage();" class="btn1">
                    <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                </a>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <ul id="list-live-videos" class="list-group"></ul>
            </div>
        </div>
    </div>
    <div class="container" id="page-live">
    </div>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCKl3QL__wYyhpBl1iBHowGLsjKz51VWE8",
            authDomain: "live-reaction.firebaseapp.com",
            databaseURL: "https://live-reaction.firebaseio.com",
            projectId: "live-reaction",
            storageBucket: "live-reaction.appspot.com",
            messagingSenderId: "956164106907"
        };
        firebase.initializeApp(config);
    </script>
    <script>
        var accounts = [];

        window.fbAsyncInit = function() {
            FB.init({
                appId: '1950700178499010',
                cookie: true,
                xfbml: true,
                version: 'v2.8'
            });
            FB.AppEvents.logPageView();

            checkLoginState();
        };

        function checkLoginState() {

            FB.getLoginStatus(function(r) {
                statusChangeCallback(r);
            });
        }

        function statusChangeCallback(r) {
            console.log(r);
            //
            if (r.status === 'connected') {
                $('#bt-login').hide();

                listAccounts(function() {

                    console.log(accounts);
                    for (var i = 0; i < accounts.length; i++) {
                        $('#accounts-list').append(
                            '<div class="col-md-3 col-sm-3 col-xs-4" style="background:rgba(255, 255, 255, 0.8);">' +
                            '<a class="page" href="javascript:" onclick="listLiveVideos(\'' +
                            accounts[i].id +
                            '\',\'' +
                            accounts[i].name +
                            '\');"><span class="icon" style="background:url(https://graph.facebook.com/' +
                            accounts[i].id +
                            '/picture) center center no-repeat"></span><span class="name">' +
                            accounts[i].name +
                            '</span></a></div>');
                    }

                    $('body').attr('class', 'accounts');
                });
            } else {

            }
        }

        function listAccounts(callback, after) {
            var withAfter = '';
            if (after != undefined)
                withAfter = '&after=' + after;

            FB.api('me/accounts?limit=20' + withAfter, function(r) {
                console.log(r);
                accounts.push.apply(accounts, r.data);

                if (r.paging &&
                    r.paging.next &&
                    r.paging.cursors &&
                    r.paging.cursors.after) {
                    listAccounts(callback, r.paging.cursors.after);
                } else {
                    callback();
                }
            });
        }

        function listLiveVideos(id, name) {
            $('#list-live-videos').html('');
            FB.api(id + '/live_videos?fields=creation_time,status,description,title,video', function(r) {
                console.log(r);
                for (var i = 0; i < r.data.length; i++) {
                    $('#list-live-videos').append('<li class="list-group-item ' + r.data[i].status + '" onclick="viewLiveReaction(\'' +
                        r.data[i].id +
                        '\')">' +
                        (r.data[i].title || '') + ' : ' +
                        (r.data[i].description || '') + ' (' + r.data[i].status + ')<br/>' +
                        r.data[i].creation_time + '</li>');
                }
            });
            $('#title-page').html(name);
            $('body').attr('class', 'videos');
        }

        function choosePage() {
            $('body').attr('class', 'accounts');
            $('#title-page').html('เลือก live');
            $('#list-live-videos').html('');
        }

        var liveID;

        function viewLiveReaction(id) {
            $('body').attr('class', 'live');

            liveID = id;

            getReactions();
        }

        function getReactions() {
            FB.api(liveID + '?fields=' +
                'reactions.type(LIKE).limit(0).summary(total_count).as(like),' +
                'reactions.type(LOVE).limit(0).summary(total_count).as(love),' +
                'reactions.type(HAHA).limit(0).summary(total_count).as(haha),' +
                'reactions.type(WOW).limit(0).summary(total_count).as(wow),' +
                'reactions.type(ANGRY).limit(0).summary(total_count).as(angry),' +
                'reactions.type(SAD).limit(0).summary(total_count).as(sad)',
                function(r) {
                    console.log(r);

                    $('#page-live').html(JSON.stringify(r));

                    if ($('body').attr('class') == 'live') {
                        setTimeout(getReactions, 5000);
                    }
                });
        }

        (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            js.src = "//connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</body>

</html>